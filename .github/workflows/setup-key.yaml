on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/setup-key.yaml'

name: Create deploy key

jobs:
  create_key:
    runs-on: ubuntu-18.04

    name: Create deploy key

    steps:
      - name: Delete existing deploy key
        run: |
          curl -s \
            --fail \
            -H"Authorization: token ${{ secrets.TOKEN_KEYS }}" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/keys \
            | tee /dev/stderr \
            | jq '.[] | .id ' | \
            while read _id; do
                    echo "- deploy key: $_id"
                    curl -s \
                      --fail \
                      -X "DELETE" \
                      -H"Authorization: token ${{ secrets.TOKEN_KEYS }}" \
                      https://api.github.com/repos/${GITHUB_REPOSITORY}/keys/$_id
            done
        shell: bash
